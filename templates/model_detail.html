<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Model Run {{ run_number }} - {{ exp_version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .parameter-plot { max-width: 100%; margin-bottom: 20px; }
        .model-spec { 
            white-space: pre;
            font-family: monospace;
            font-size: 0.95em;
            line-height: 1.6;
            padding: 1em;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            margin: 0;
            overflow-x: auto;
            overflow-y: visible;
            display: block;
            min-width: 100%;
            tab-size: 2;
            position: relative;
        }
        .model-spec-container {
            overflow-x: auto;
            overflow-y: visible;
            margin: -1rem;
            padding: 1rem;
            position: relative;
        }
        .metadata-section { margin-top: 30px; }
        .learnable-param, .variable-name { 
            position: relative;
            display: inline-block;
        }
        .learnable-param { 
            color: #198754;  /* Bootstrap's success green */
            font-weight: 500;
            cursor: help;
        }
        .variable-name {
            font-weight: 500;
            color: #0d6efd;
            cursor: help;
        }
        .variable-description {
            font-size: 0.9em;
            color: #666;
            margin-left: 1em;
        }
        .variable-range {
            font-size: 0.85em;
            color: #888;
            margin-left: 1em;
            font-style: italic;
        }
        .tooltip-text {
            visibility: hidden;
            position: absolute;
            z-index: 9999;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            width: max-content;
            max-width: 300px;
            top: -5px;
            left: 50%;
            transform: translate(-50%, -100%);
            margin-bottom: 5px;
            white-space: normal;
        }
        .variable-name:hover .tooltip-text,
        .learnable-param:hover .tooltip-text {
            visibility: visible;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .full-reasoning {
            white-space: pre-wrap;
            font-size: 0.9em;
            line-height: 1.5;
            color: #444;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: 500;
        }
        /* NEW TOOLTIP STYLES */
        .variable-hover {
            position: relative;
            display: inline-block;
        }
        .variable-tooltip {
            display: none;
            position: fixed;
            z-index: 9999;
            background-color: #1e1e1e;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            width: max-content;
            max-width: 300px;
            white-space: pre-line;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .variable-tooltip::before {
            content: "";
            position: absolute;
            border-width: 6px;
            border-style: solid;
        }
        .variable-tooltip[style*="--arrow-position: bottom"]::before {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-color: #1e1e1e transparent transparent transparent;
        }
        .variable-tooltip[style*="--arrow-position: top"]::before {
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-color: transparent transparent #1e1e1e transparent;
        }
        
        /* Model Interaction History Styles */
        .interaction-timestamp {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: normal;
        }
        .interaction-name {
            font-weight: 500;
            color: #212529;
        }
        .accordion-button {
            font-weight: 400;
            display: flex;
            align-items: center;
        }
        .accordion-button:not(.collapsed) {
            background-color: #f0f7ff;
        }
        .accordion-button .badge {
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 24px;
        }
        .nav-tabs .nav-link {
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
        }
        #interactionAccordion pre {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            tab-size: 4;
            border: 1px solid rgba(0,0,0,0.1);
        }
        #interactionAccordion pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #interactionAccordion pre::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #interactionAccordion pre::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        #interactionAccordion pre::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Styles for the Errors tab */
        .error-history pre {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .accordion-button:focus {
            box-shadow: none;
            border-color: rgba(0,0,0,.125);
        }
        .error-count-badge {
            font-size: 0.9em;
            padding: 0.25em 0.6em;
            margin-left: 0.5em;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/?experiment={{ exp_version }}">Experiments</a></li>
                <li class="breadcrumb-item active">Run {{ run_number }}</li>
            </ol>
        </nav>

        <h1 class="mb-4">Model Run {{ run_number }}</h1>

        <!-- Model Specification -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">Model Specification</h3>
            </div>
            <div class="card-body">
                <div class="model-spec-container">
                    <div class="model-spec" id="modelSpec">{{ model_info['model_specification'] }}</div>
                </div>
            </div>
        </div>

        <!-- Parameter Recovery Plots -->
        {% if plot_files %}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">Parameter Recovery Plots</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for plot_file in plot_files %}
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                {{ plot_file.replace('parameter_recovery_', '').replace('.png', '').replace('_', ' ').title() }}
                            </div>
                            <div class="card-body">
                                <img src="{{ url_for('serve_plot', exp_version=exp_version, run_number=run_number, filename=plot_file) }}" 
                                     class="parameter-plot" 
                                     alt="{{ plot_file }}">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tabbed Content -->
        <ul class="nav nav-tabs mb-4" id="modelTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="variables-tab" data-bs-toggle="tab" data-bs-target="#variables" type="button" role="tab">
                    Variables
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                    Performance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reasoning-tab" data-bs-toggle="tab" data-bs-target="#reasoning" type="button" role="tab">
                    Development Reasoning
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                    Configuration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button" role="tab">
                    Errors
                    {% if metadata.get('simulation_errors') %}
                        <span class="badge bg-danger error-count-badge">{{ metadata.get('simulation_errors')|length }}</span>
                    {% endif %}
                </button>
            </li>
        </ul>

        <div class="tab-content" id="modelTabsContent">
            <!-- Variables Tab -->
            <div class="tab-pane fade show active" id="variables" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        {% if metadata.variable_descriptions %}
                            {% for var_name, var_info in metadata.variable_descriptions.items() %}
                                <div class="mb-3">
                                    <div class="variable-name">
                                        {{ var_name }}
                                        <span class="tooltip-text">{{ var_info.description }}</span>
                                    </div>
                                    <div class="variable-description">{{ var_info.description }}</div>
                                    {% if var_info.range %}
                                        <div class="variable-range">
                                            Range: {{ var_info.range.min }} to {{ var_info.range.max }}
                                            {% if var_info.distribution %}
                                                ({{ var_info.distribution }})
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No variable descriptions available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="h6">BIC Scores</h4>
                                {% if metadata.get('average_bic') is not none %}
                                    <div class="mb-3">
                                        <p class="mb-2"><strong>Overall:</strong> {{ metadata.get('average_bic')|safe_float }}</p>
                                        
                                        <div class="mt-2">
                                            <p class="mb-2"><strong>Group-specific:</strong></p>
                                            {% for key, value in metadata.items() %}
                                                {% if key.startswith('bic_') and key != 'bic_error' %}
                                                    <p class="mb-1 ms-3">{{ key[4:] }}: {{ value|safe_float }}</p>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="text-muted">BIC results not found in metadata.</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h4 class="h6">Parameter Recovery Scores</h4>
                                {% if metadata.group_analysis %}
                                    {% for group in metadata.group_analysis.groups %}
                                        <div class="mb-3">
                                            <h5 class="h6 text-muted">{{ group|title }}</h5>
                                            {% for key, value in model_info.items() %}
                                                {% if key.endswith('_recovery_' ~ group) and value is not none and value > 0 %}
                                                    {% set param = key.replace('_recovery_' ~ group, '') %}
                                                    <div>
                                                        <strong>{{ param|title }}:</strong> 
                                                        {{ value|safe_float }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                    <div class="mb-3">
                                        <h5 class="h6 text-muted">Overall</h5>
                                        {% for key, value in model_info.items() %}
                                            {% if key.endswith('_recovery') and not '_recovery_' in key and value is not none and value > 0 %}
                                                <div>
                                                    <strong>{{ key.replace('_recovery', '')|title }}:</strong> 
                                                    {{ value|safe_float }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {% for key, value in model_info.items() %}
                                        {% if key.endswith('_recovery') and value is not none and value > 0 %}
                                            <div>
                                                <strong>{{ key.replace('_recovery', '')|title }}:</strong> 
                                                {{ value|safe_float }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Add Group Parameter Averages section -->
                        {% if metadata.group_parameter_averages %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4 class="h6">Group Parameter Averages</h4>
                                <div class="row">
                                    {% for group, params in metadata.group_parameter_averages.items() %}
                                    <div class="col-md-6 mb-3">
                                        <h5 class="h6 text-muted">{{ group|title }}</h5>
                                        {% for param, avg in params.items() %}
                                        <div>
                                            <strong>{{ param|title }}:</strong> 
                                            {{ avg|safe_float }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Development Reasoning Tab -->
            <div class="tab-pane fade" id="reasoning" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        {% if metadata.full_reasoning %}
                            <div class="full-reasoning">{{ metadata.full_reasoning }}</div>
                        {% else %}
                            <p class="text-muted">No reasoning information available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <pre class="bg-light p-3 rounded"><code>{{ metadata|tojson(indent=2) }}</code></pre>
                    </div>
                </div>
            </div>
            
            <!-- Errors Tab -->
            <div class="tab-pane fade" id="errors" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h4 class="h5 mb-3">Simulation Retry Information</h4>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                {% if metadata.get('total_retries') is not none %}
                                    <div class="alert alert-info">
                                        <strong>Total Retries:</strong> {{ metadata.get('total_retries') }}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <strong>Total Retries:</strong> Not available
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {% if metadata.get('simulation_error') %}
                                    <div class="alert alert-danger">
                                        <strong>Last Error:</strong>
                                        <pre class="mb-0 mt-2 small">{{ metadata.get('simulation_error') }}</pre>
                                    </div>
                                {% else %}
                                    <div class="alert alert-success">
                                        <strong>No errors</strong> in final simulation
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if metadata.get('simulation_errors') %}
                            <h5 class="h6 mt-4 mb-3">Error History</h5>
                            <div class="error-history table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%">Retry #</th>
                                            <th style="width: 70%">Error</th>
                                            <th style="width: 20%">Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for error in metadata.get('simulation_errors', []) %}
                                            <tr>
                                                <td>{{ error.retry_number }}</td>
                                                <td><pre class="mb-0 small">{{ error.error }}</pre></td>
                                                <td>{{ error.timestamp|timestamp_to_datetime }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-success mt-3">
                                <strong>No errors recorded</strong> - The simulation ran successfully on the first attempt.
                            </div>
                        {% endif %}
                        
                        {% if metadata.get('complete_model_interaction') %}
                            <h5 class="h6 mt-4 mb-3">Model Interaction History</h5>
                            <div class="accordion" id="interactionAccordion">
                                {% for interaction in metadata.get('complete_model_interaction') %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#interaction{{ loop.index }}" aria-expanded="false">
                                                <span class="me-2 badge rounded-pill bg-primary">{{ loop.index }}</span>
                                                <span class="interaction-name">{{ interaction.solver }}</span>
                                                {% if interaction.timestamp %}
                                                    <span class="interaction-timestamp ms-auto">{{ interaction.timestamp|timestamp_to_datetime }}</span>
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="interaction{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#interactionAccordion">
                                            <div class="accordion-body">
                                                <ul class="nav nav-tabs mb-3" id="interaction-tabs-{{ loop.index }}" role="tablist">
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link active" id="input-tab-{{ loop.index }}" data-bs-toggle="tab" 
                                                                data-bs-target="#input-content-{{ loop.index }}" type="button" role="tab" 
                                                                aria-controls="input-content-{{ loop.index }}" aria-selected="true">
                                                            Input Prompt
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="output-tab-{{ loop.index }}" data-bs-toggle="tab" 
                                                                data-bs-target="#output-content-{{ loop.index }}" type="button" role="tab" 
                                                                aria-controls="output-content-{{ loop.index }}" aria-selected="false">
                                                            Model Output
                                                        </button>
                                                    </li>
                                                    <li class="nav-item ms-auto" role="presentation">
                                                        <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                                                data-target-tab="input-content-{{ loop.index }}"
                                                                title="Copy to clipboard">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                                            </svg>
                                                            <span class="visually-hidden">Copy</span>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary print-btn ms-1"
                                                                data-target-tab="input-content-{{ loop.index }}"
                                                                title="Print content">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                                                                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                                                                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 14h6a1 1 0 0 0 1-1v-1H4v1a1 1 0 0 0 1 1m7-1V8H4v8zm2-1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                                                                <path d="M5 11.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                                                            </svg>
                                                            <span class="visually-hidden">Print</span>
                                                        </button>
                                                    </li>
                                                </ul>
                                                
                                                <div class="tab-content">
                                                    <div class="tab-pane fade show active" id="input-content-{{ loop.index }}" role="tabpanel" 
                                                         aria-labelledby="input-tab-{{ loop.index }}">
                                                        <pre class="bg-light p-3 rounded small" style="height: 500px; overflow: auto;">{{ interaction.input }}</pre>
                                                    </div>
                                                    <div class="tab-pane fade" id="output-content-{{ loop.index }}" role="tabpanel" 
                                                         aria-labelledby="output-tab-{{ loop.index }}">
                                                        <pre class="bg-light p-3 rounded small" style="height: 500px; overflow: auto;">{{ interaction.output }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Create a JSON object of learnable parameters and their recovery scores
        const learnableParams = {};
        {% for key, value in model_info.items() %}
            {% if key.endswith('_recovery') and value is not none and value > 0 %}
                learnableParams["{{ key.replace('_recovery', '') }}"] = {{ value }};
            {% endif %}
        {% endfor %}

        // Create a JSON object of variable descriptions
        const variableDescriptions = {};
        {% if metadata.variable_descriptions %}
            {% for var_name, var_info in metadata.variable_descriptions.items() %}
                variableDescriptions["{{ var_name }}"] = "{{ var_info.description|replace('"', '\\"') }}";
            {% endfor %}
        {% endif %}

        function updateTooltipPosition(event) {
            const tooltip = event.target.querySelector('.variable-tooltip');
            if (!tooltip) return;

            const rect = event.target.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // Calculate initial position above the variable
            let top = rect.top - tooltip.offsetHeight - 10;
            let left = rect.left + (rect.width / 2);

            // If tooltip would go above viewport, show it below instead
            if (top < 10) {
                top = rect.bottom + 10;
                tooltip.style.setProperty('--arrow-position', 'top');
            } else {
                tooltip.style.setProperty('--arrow-position', 'bottom');
            }

            // Ensure tooltip doesn't go off the right edge
            const rightEdge = left + (tooltip.offsetWidth / 2);
            if (rightEdge > window.innerWidth - 10) {
                left = window.innerWidth - 10 - (tooltip.offsetWidth / 2);
            }

            // Ensure tooltip doesn't go off the left edge
            if (left < (tooltip.offsetWidth / 2) + 10) {
                left = (tooltip.offsetWidth / 2) + 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.style.transform = 'translate(-50%, 0)';
        }

        function highlightParameters() {
            const modelSpec = document.getElementById('modelSpec');
            if (!modelSpec) return;
            
            let text = modelSpec.textContent;      
            
            // Get the list of variable names (keys) and sort by length descending.
            const paramNames = Object.keys(variableDescriptions).sort((a, b) => b.length - a.length);
            
            // Build a regex pattern that matches exact variable names (word-boundaries)
            const pattern = new RegExp(
                paramNames.map(param => {
                    // Escape special regex characters.
                    const escaped = param.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    return '\\b' + escaped + '\\b';
                }).join('|'),
                'g'
            );
            
            const highlightedText = text.replace(pattern, function(match) {
                // Get the description from our JSON objects.
                const description = variableDescriptions[match] || "";
                const recovery = learnableParams.hasOwnProperty(match) ? learnableParams[match] : null;
                const tooltipText = recovery ? `${description}\nRecovery: ${recovery.toFixed(2)}` : description;
                // If the parameter is learnable, add an extra class (learnable-param)
                const extraClass = learnableParams.hasOwnProperty(match) ? "learnable-param" : "variable-name";
                // Return a span wrapping the match with an inner span for tooltip.
                return `<span class="variable-hover ${extraClass}" onmousemove="updateTooltipPosition(event)" onmouseover="this.querySelector('.variable-tooltip').style.display='block'" onmouseout="this.querySelector('.variable-tooltip').style.display='none'">${match}<span class="variable-tooltip">${tooltipText}</span></span>`;
            });
            
            modelSpec.innerHTML = highlightedText;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize parameter highlighting
            highlightParameters();
            
            // Add listeners to adjust pre elements when an accordion item is expanded
            document.querySelectorAll('#interactionAccordion .accordion-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Wait for collapse animation to complete
                    setTimeout(() => {
                        const collapseId = this.getAttribute('data-bs-target');
                        const collapseEl = document.querySelector(collapseId);
                        
                        if (collapseEl && this.getAttribute('aria-expanded') === 'true') {
                            // Auto-resize code blocks when accordion is opened
                            const preElements = collapseEl.querySelectorAll('pre');
                            preElements.forEach(pre => {
                                // Set initial height to content height (up to 500px max)
                                const contentHeight = Math.min(pre.scrollHeight, 500);
                                pre.style.height = contentHeight + 'px';
                            });
                            
                            // Update copy/print buttons to target the active tab
                            const activeTabPane = collapseEl.querySelector('.tab-pane.active');
                            if (activeTabPane) {
                                const tabId = activeTabPane.id;
                                collapseEl.querySelectorAll('.copy-btn, .print-btn').forEach(btn => {
                                    btn.setAttribute('data-target-tab', tabId);
                                });
                            }
                        }
                    }, 350);
                });
            });
            
            // Add listeners for tab switching to adjust pre element height and update copy/print buttons
            document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function() {
                    const targetId = this.getAttribute('data-bs-target');
                    const targetPane = document.querySelector(targetId);
                    if (targetPane) {
                        const pre = targetPane.querySelector('pre');
                        if (pre) {
                            // Adjust height based on content (up to 500px max)
                            const contentHeight = Math.min(pre.scrollHeight, 500);
                            pre.style.height = contentHeight + 'px';
                        }
                        
                        // Update copy/print buttons to target this tab
                        const accordionBody = targetPane.closest('.accordion-body');
                        if (accordionBody) {
                            accordionBody.querySelectorAll('.copy-btn, .print-btn').forEach(btn => {
                                btn.setAttribute('data-target-tab', targetId.substring(1)); // Remove the # prefix
                            });
                        }
                    }
                });
            });
            
            // Handle copy button clicks
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-target-tab');
                    const tabPane = document.getElementById(tabId);
                    if (tabPane) {
                        const pre = tabPane.querySelector('pre');
                        if (pre) {
                            const textToCopy = pre.textContent;
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                // Show success feedback
                                const originalTitle = this.getAttribute('title');
                                this.setAttribute('title', 'Copied!');
                                this.classList.add('btn-success');
                                this.classList.remove('btn-outline-secondary');
                                
                                // Reset button after a short delay
                                setTimeout(() => {
                                    this.setAttribute('title', originalTitle);
                                    this.classList.remove('btn-success');
                                    this.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy text: ', err);
                            });
                        }
                    }
                });
            });
            
            // Handle print button clicks
            document.querySelectorAll('.print-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-target-tab');
                    const tabPane = document.getElementById(tabId);
                    if (tabPane) {
                        const pre = tabPane.querySelector('pre');
                        if (pre) {
                            const content = pre.textContent;
                            const interactionHeader = this.closest('.accordion-item').querySelector('.accordion-button').textContent.trim();
                            const tabLabel = this.closest('.accordion-body').querySelector('.nav-link.active').textContent.trim();
                            
                            // Create a new window for printing
                            const printWindow = window.open('', '_blank');
                            printWindow.document.write(`
                                <html>
                                <head>
                                    <title>${interactionHeader} - ${tabLabel}</title>
                                    <style>
                                        body { font-family: monospace; white-space: pre-wrap; padding: 20px; }
                                        header { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
                                        h1 { font-size: 16px; margin-bottom: 5px; }
                                        h2 { font-size: 14px; color: #666; margin-top: 0; }
                                        pre { white-space: pre-wrap; font-size: 12px; line-height: 1.5; }
                                    </style>
                                </head>
                                <body>
                                    <header>
                                        <h1>${interactionHeader}</h1>
                                        <h2>${tabLabel}</h2>
                                    </header>
                                    <pre>${content}</pre>
                                </body>
                                </html>
                            `);
                            printWindow.document.close();
                            
                            // Allow a moment for the content to load before printing
                            setTimeout(() => {
                                printWindow.print();
                            }, 250);
                        }
                    }
                });
            });
        });
    </script>
</body>
</html> 